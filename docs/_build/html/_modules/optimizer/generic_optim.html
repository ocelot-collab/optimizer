<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>optimizer.generic_optim &#8212; OcelotOptimizer 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OcelotOptimizer 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for optimizer.generic_optim</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is deep modification of SLAC version of the Ocelot GUI for the European XFEL facility.</span>
<span class="sd">Sergey Tomin, 2017.</span>
<span class="sd">Ocelot GUI, interface for running and testing accelerator optimization methods</span>
<span class="sd">This file primarily contains the code for the UI and GUI</span>
<span class="sd">The scanner classes are contained in an external file, scannerThreads.py</span>
<span class="sd">The resetpanel widget is also contained in a separate module, resetpanel</span>
<span class="sd">Tyler Cope, 2016</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
<span class="n">indx</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ocelot/optimizer&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="n">indx</span><span class="p">])</span>

<span class="c1"># for pyqtgraph import</span>
<span class="c1">#sys.path.append(path[:indx]+&quot;ocelot&quot;)</span>



<span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="k">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QFrame</span><span class="p">,</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="k">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="c1">#normal imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">imp</span> <span class="k">import</span> <span class="n">reload</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">reload</span>


<span class="kn">from</span> <span class="nn">ocelot.optimizer.gui_main</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">ocelot.optimizer.mint.opt_objects</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ocelot.optimizer.mint</span> <span class="k">import</span> <span class="n">mint</span>
<span class="kn">from</span> <span class="nn">ocelot.optimizer.mint</span> <span class="k">import</span> <span class="n">opt_objects</span> <span class="k">as</span> <span class="n">obj</span>

<span class="kn">from</span> <span class="nn">ocelot.utils</span> <span class="k">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">ocelot.optimizer.mint.xfel_interface</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="OcelotInterfaceWindow"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow">[docs]</a><span class="k">class</span> <span class="nc">OcelotInterfaceWindow</span><span class="p">(</span><span class="n">QFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main class for the GUI application &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the GUI and QT UI aspects of the application.</span>
<span class="sd">        Initialize the scan parameters.</span>
<span class="sd">        Connect start and logbook buttons on the scan panel.</span>
<span class="sd">        Initialize the plotting.</span>
<span class="sd">        Make the timer object that updates GUI on clock cycle during a scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PATHS</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ocelot&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;optimizer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path2ocelot</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2ocelot</span> <span class="o">+</span> <span class="s2">&quot;ocelot&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;optimizer&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2ocelot</span> <span class="o">+</span> <span class="s2">&quot;config_optim&quot;</span> <span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">+</span> <span class="s2">&quot;default.json&quot;</span> <span class="c1"># ./parameters/default.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_path</span> <span class="o">+</span> <span class="s2">&quot;mint&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;obj_function.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">+</span>  <span class="s2">&quot;obj_funcs&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="c1"># initialize</span>
        <span class="n">QFrame</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logbook</span> <span class="o">=</span> <span class="s2">&quot;xfellog&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_mode</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name_simplex</span> <span class="o">=</span> <span class="s2">&quot;Nelder-Mead Simplex&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_gauss</span> <span class="o">=</span> <span class="s2">&quot;Gaussian Process&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_gauss_sklearn</span> <span class="o">=</span> <span class="s2">&quot;Gaussian Process sklearn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_custom</span> <span class="o">=</span> <span class="s2">&quot;Custom Minimizer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_simplex_norm</span> <span class="o">=</span> <span class="s2">&quot;Simplex Norm.&quot;</span>
        <span class="c1"># self.name4 = &quot;Conjugate Gradient&quot;</span>
        <span class="c1"># self.name5 = &quot;Powell&#39;s Method&quot;</span>
        <span class="c1"># switch of GP and custom Mininimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_simplex</span><span class="p">)</span>
        <span class="c1">#self.ui.cb_select_alg.addItem(self.name_gauss)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_custom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_simplex_norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_gauss_sklearn</span><span class="p">)</span>


        <span class="c1">#self.ui.pb_help.clicked.connect(lambda: os.system(&quot;firefox file://&quot;+self.optimizer_path+&quot;docs/build/html/index.html&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_help</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">open_help</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mi</span> <span class="o">=</span> <span class="n">TestMachineInterface</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mi</span> <span class="o">=</span> <span class="n">XFELMachineInterface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">TestDeviceProperties</span><span class="p">(</span><span class="n">ui</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_tdelay</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">OptControl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span><span class="o">.</span><span class="n">alarm_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_alarm_timeout</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1">#self.objective_func = obj_function.XFELTarget()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_func_pv</span> <span class="o">=</span> <span class="s2">&quot;test_obj&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_obj_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPlots</span><span class="p">()</span>

        <span class="c1"># database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">+</span> <span class="s2">&quot;test.db&quot;</span> <span class="c1">#&quot;./parameters/test.db&quot;</span>
        <span class="c1"># db.create_db(self.dbname)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">PerfDB</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Database is not available&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyper_file</span> <span class="o">=</span> <span class="s2">&quot;../parameters/hyperparameters.npy&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_scan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_edit_obj_func</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_editor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_use_predef</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_obj_fun</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">restore_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_obj_func</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span><span class="p">),</span> <span class="s1">&#39;mint/obj_function.py&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">set_obj_fun</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">MachineStatus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_m_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">OptControl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span><span class="o">.</span><span class="n">m_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span>


        <span class="c1">#timer for plots, starts when scan starts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiPvTimer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiPvTimer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPlotData</span><span class="p">)</span>


<div class="viewcode-block" id="OcelotInterfaceWindow.scan_method_select"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.scan_method_select">[docs]</a>    <span class="k">def</span> <span class="nf">scan_method_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets scanner method from options panel combo box selection.</span>
<span class="sd">        This method executes from the runScan() method, when the UI &quot;Start Scan&quot; button is pressed.</span>
<span class="sd">        :return: Selected scanner object</span>
<span class="sd">                 These objects are contrained in the scannerThreads.py file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>

        <span class="c1">#GP Method</span>
        <span class="k">if</span> <span class="n">current_method</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_gauss</span><span class="p">:</span>
            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">GaussProcess</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">current_method</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_gauss_sklearn</span><span class="p">:</span>
            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">GaussProcessSKLearn</span><span class="p">()</span>
        <span class="c1"># Custom Minimizer</span>
        <span class="k">elif</span> <span class="n">current_method</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_custom</span><span class="p">:</span>
            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">CustomMinimizer</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">current_method</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_simplex_norm</span><span class="p">:</span>
            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">Simplex</span><span class="p">()</span>

        <span class="c1">#simplex Method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">Simplex</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

        <span class="k">return</span> <span class="n">minimizer</span></div>


<div class="viewcode-block" id="OcelotInterfaceWindow.closeEvent"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">save_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Stop optimization&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">opt_ctrl</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span><span class="o">.</span><span class="n">is_ok</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: rgb(85, 255, 127);&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Start optimization&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">QFrame</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.start_scan"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.start_scan">[docs]</a>    <span class="k">def</span> <span class="nf">start_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to start/stop the Optimizer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanStartTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Stop optimization&quot;</span><span class="p">:</span>
            <span class="c1"># stop the optimization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">opt_ctrl</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span><span class="o">.</span><span class="n">is_ok</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span>
            <span class="c1"># Save the optimization parameters to the database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save2db</span><span class="p">()</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
            <span class="c1"># Setting the button</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: rgb(85, 255, 127);&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Start optimization&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">getPvsFromCbState</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Check Devices&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dev</span><span class="o">.</span><span class="n">check_limits</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Check the Limits&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpMultiPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiPvTimer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># set the Objective function from GUI or from file mint.obj_function.py (reloading)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_obj_fun</span><span class="p">()</span>

        <span class="c1"># Set minimizer - the optimization method (Simplex, GP, ...)</span>
        <span class="n">minimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_method_select</span><span class="p">()</span>

        <span class="c1"># configure the Minimizer</span>
        <span class="k">if</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mint</span><span class="o">.</span><span class="n">GaussProcess</span><span class="p">,</span> <span class="n">mint</span><span class="o">.</span><span class="n">GaussProcessSKLearn</span><span class="p">]:</span>
            <span class="n">minimizer</span><span class="o">.</span><span class="n">seed_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_seed_iter</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">minimizer</span><span class="o">.</span><span class="n">seed_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_tdelay</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">minimizer</span><span class="o">.</span><span class="n">hyper_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyper_file</span>
            <span class="n">minimizer</span><span class="o">.</span><span class="n">norm_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_isim_rel_step</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">/</span> <span class="mf">100.</span>

        <span class="k">elif</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">mint</span><span class="o">.</span><span class="n">Simplex</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_use_isim</span><span class="o">.</span><span class="n">checkState</span><span class="p">():</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dev</span><span class="o">.</span><span class="n">simplex_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lims</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_limits</span><span class="p">()</span>
                        <span class="n">rel_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_isim_rel_step</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                        <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">rel_step</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">mint</span><span class="o">.</span><span class="n">CustomMinimizer</span><span class="p">:</span>
            <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dev</span><span class="o">.</span><span class="n">simplex_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lims</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_limits</span><span class="p">()</span>
                    <span class="n">rel_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_isim_rel_step</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rel_step</span><span class="p">)</span>
                    <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">rel_step</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MINImizer steps&quot;</span><span class="p">,</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">dev_steps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_num_iter</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">minimizer</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span>

        <span class="c1"># Optimizer initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">mint</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_select_alg</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_simplex_norm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">normalization</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">norm_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_isim_rel_step</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">norm_coef</span><span class="p">)</span>
        <span class="c1"># Option - set best solution after optimization or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">set_best_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_set_best_sol</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_m_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span><span class="o">.</span><span class="n">m_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">opt_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_delay</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">minimizer</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">mint</span><span class="o">.</span><span class="n">Action</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">max_target_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span>

        <span class="c1">#self.opt.eval(seq)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Setting the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Stop optimization&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: red&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.scan_finished"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.scan_finished">[docs]</a>    <span class="k">def</span> <span class="nf">scan_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Stop optimization&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">isAlive</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: rgb(85, 255, 127);&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_start_scan</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Start optimization&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save2db</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scan_finished: OK&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scan_finished: ERROR&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.create_devices"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.create_devices">[docs]</a>    <span class="k">def</span> <span class="nf">create_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create devices using only channels (PVs)</span>

<span class="sd">        :param pvs: str, device address/channel/PV</span>
<span class="sd">        :return: list of the devices [mint.opt_objects.Device(eid=pv[0]), mint.opt_objects.Device(eid=pv[1]), ... ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add new method for creation of devices</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">:</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">TestDevice</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">pv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">pv</span><span class="p">)</span>
            <span class="n">dev</span><span class="o">.</span><span class="n">mi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span>
            <span class="n">dev</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">devices</span></div>


<div class="viewcode-block" id="OcelotInterfaceWindow.indicate_machine_state"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.indicate_machine_state">[docs]</a>    <span class="k">def</span> <span class="nf">indicate_machine_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to indicate of the machine status. Red frames around graphics means that machine status is not OK.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_control</span><span class="o">.</span><span class="n">is_ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_3</span><span class="o">.</span><span class="n">styleSheet</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;background-color:red;&quot;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_2</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color:red;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_3</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color:red;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_3</span><span class="o">.</span><span class="n">styleSheet</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;background-color:323232;&quot;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_2</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color:323232;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_3</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color:323232;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OcelotInterfaceWindow.save2db"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.save2db">[docs]</a>    <span class="k">def</span> <span class="nf">save2db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save optimization parameters to the Database</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dump2json</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;devs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;currents&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;iter&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sase&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;pen&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;obj&quot;</span><span class="p">:[]}</span>
        <span class="n">d_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d_stop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;devs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="n">d_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span> <span class="o">+</span> <span class="s2">&quot;_val&quot;</span><span class="p">)</span>
            <span class="n">d_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d_stop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;currents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dev</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

            <span class="n">d_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span> <span class="o">+</span> <span class="s2">&quot;_lim&quot;</span><span class="p">)</span>
            <span class="n">d_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">get_limits</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d_stop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">get_limits</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dump2json</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;sase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;pen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_params</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span>

        <span class="n">o_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;obj_id&quot;</span><span class="p">,</span> <span class="s2">&quot;obj_value&quot;</span><span class="p">,</span> <span class="s2">&quot;obj_pen&quot;</span><span class="p">,</span> <span class="s2">&quot;niter&quot;</span><span class="p">]</span>
        <span class="n">o_start</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">]</span>
        <span class="n">o_stop</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span><span class="p">)]</span>


        <span class="n">start_sase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop_sase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#print(&#39;current actions in tuning&#39;, [(t.id, t.tuning_id, t.sase_start, t.sase_end) for t in self.db.get_actions()])</span>


        <span class="c1"># add new data here START</span>
        <span class="n">new_data_name</span> <span class="o">=</span>  <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="n">new_data_start</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span>
        <span class="n">new_data_end</span> <span class="o">=</span>   <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span>
        <span class="c1"># add new data here END</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="n">o_names</span> <span class="o">+</span> <span class="n">d_names</span> <span class="o">+</span> <span class="n">new_data_name</span>
        <span class="n">start_vals</span> <span class="o">=</span> <span class="n">o_start</span><span class="o">+</span><span class="n">d_start</span> <span class="o">+</span> <span class="n">new_data_start</span>
        <span class="n">end_vals</span> <span class="o">=</span> <span class="n">o_stop</span><span class="o">+</span><span class="n">d_stop</span> <span class="o">+</span> <span class="n">new_data_end</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">new_tuning</span><span class="p">({</span><span class="s1">&#39;wl&#39;</span><span class="p">:</span> <span class="mf">13.6</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_charge</span><span class="p">(),</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;test tuning&#39;</span><span class="p">})</span>
            <span class="n">tune_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">current_tuning_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">new_action</span><span class="p">(</span><span class="n">tune_id</span><span class="p">,</span> <span class="n">start_sase</span><span class="o">=</span><span class="n">start_sase</span><span class="p">,</span> <span class="n">end_sase</span><span class="o">=</span><span class="n">stop_sase</span><span class="p">)</span>

            <span class="n">action_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">current_action_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_action_parameters</span><span class="p">(</span><span class="n">tune_id</span><span class="p">,</span> <span class="n">action_id</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">start_vals</span><span class="o">=</span><span class="n">start_vals</span><span class="p">,</span>
                                     <span class="n">end_vals</span><span class="o">=</span><span class="n">end_vals</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current actions&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tuning_id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">sase_start</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">sase_end</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_actions</span><span class="p">()])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current action parameters&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">tuning_id</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">action_id</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">par_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">start_value</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">end_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_action_parameters</span><span class="p">(</span><span class="n">tune_id</span><span class="p">,</span> <span class="n">action_id</span><span class="p">)])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Database error&quot;</span><span class="p">)</span>

        <span class="n">dump2json</span><span class="p">[</span><span class="s2">&quot;dev_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span>
        <span class="n">dump2json</span><span class="p">[</span><span class="s2">&quot;obj_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dump2json</span><span class="p">[</span><span class="s2">&quot;obj_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">times</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ocelot&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H-%M-%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="c1">#print(filename)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dump2json</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR. Could not write history&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.set_obj_fun"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.set_obj_fun">[docs]</a>    <span class="k">def</span> <span class="nf">set_obj_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to set objective function from the GUI (channels A,B,C) or reload module obj_function.py</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ocelot.optimizer.mint</span> <span class="k">import</span> <span class="n">obj_function</span>
            <span class="n">reload</span><span class="p">(</span><span class="n">obj_function</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_edit_obj_func</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background: #4e4e4e&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">pb_edit_obj_func</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background: red&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_use_predef</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR set objective function&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">use_predef_fun</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cb_use_predef</span><span class="o">.</span><span class="n">checkState</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RELOAD Module Objective Function&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span> <span class="o">=</span> <span class="n">obj_function</span><span class="o">.</span><span class="n">XFELTarget</span><span class="p">(</span><span class="n">mi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># disable button &quot;Edit Objective Function&quot;</span>
            <span class="c1"># self.ui.pb_edit_obj_func.setEnabled(False)</span>
            <span class="n">line_edits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_e</span><span class="p">]</span>

            <span class="n">a_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_a</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">state_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_a</span><span class="p">)</span>

            <span class="n">b_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_b</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">state_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_b</span><span class="p">)</span>

            <span class="n">c_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_c</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">state_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_c</span><span class="p">)</span>

            <span class="n">d_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_d</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">state_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_d</span><span class="p">)</span>

            <span class="n">e_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_e</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">state_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_e</span><span class="p">)</span>

            <span class="n">func</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_obf</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>

            <span class="k">def</span> <span class="nf">get_value_exp</span><span class="p">():</span>
                <span class="n">A</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">C</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">D</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">E</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">if</span> <span class="n">state_a</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">a_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state_b</span><span class="p">:</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">b_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state_c</span><span class="p">:</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">c_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state_d</span><span class="p">:</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">d_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state_e</span><span class="p">:</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">e_str</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">a_str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">get_value_exp</span>

        <span class="c1"># set maximum penalty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">pen_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_max_pen</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="c1"># set number of the readings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">nreadings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_nreadings</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="c1"># set interval between readings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_ddelay</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_value_dev_mode</span><span class="p">():</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dev</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am here!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">values</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">get_value_dev_mode</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.set_m_status"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.set_m_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_m_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to set the MachineStatus method self.is_ok using GUI Alarm channel and limits</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">alarm_dev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_alarm</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;alarm_dev&quot;</span><span class="p">,</span> <span class="n">alarm_dev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alarm_dev</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">is_le_addr_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">le_alarm</span><span class="p">)</span>
        <span class="c1">#state = False</span>

        <span class="n">a_dev</span> <span class="o">=</span> <span class="n">AlarmDevice</span><span class="p">(</span><span class="n">alarm_dev</span><span class="p">)</span>
        <span class="n">a_dev</span><span class="o">.</span><span class="n">mi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mi</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">is_ok</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALARM switched off&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">is_ok</span><span class="p">():</span>
                <span class="c1">#alarm_dev = str(self.ui.le_alarm.text())</span>
                <span class="n">alarm_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_alarm_min</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="n">alarm_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">sb_alarm_max</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="c1">#alarm_value = self.mi.get_value(alarm_dev)</span>

                <span class="n">alarm_value</span> <span class="o">=</span> <span class="n">a_dev</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALARM: &quot;</span><span class="p">,</span> <span class="n">alarm_value</span><span class="p">,</span> <span class="n">alarm_min</span><span class="p">,</span> <span class="n">alarm_max</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alarm_min</span> <span class="o">&lt;=</span> <span class="n">alarm_value</span> <span class="o">&lt;=</span> <span class="n">alarm_max</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_status</span><span class="o">.</span><span class="n">is_ok</span> <span class="o">=</span> <span class="n">is_ok</span></div>


<div class="viewcode-block" id="OcelotInterfaceWindow.getPlotData"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.getPlotData">[docs]</a>    <span class="k">def</span> <span class="nf">getPlotData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collects data and updates plot on every GUI clock cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#get times, penalties obj func data from the machine interface</span>

        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">penalties</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_line</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_obj_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_value</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1">#plot data for all devices being scanned</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiPlotStarts</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">times</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilines</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span>
            <span class="n">line</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="OcelotInterfaceWindow.addPlots"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.addPlots">[docs]</a>    <span class="k">def</span> <span class="nf">addPlots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the GUIs plots and labels on startup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.objective_func_pv = &quot;test_obj&quot;</span>
        <span class="c1">#setup plot 1 for obj func monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot1</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Objective Function Monitor&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_func_pv</span><span class="p">),</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="s2">&quot;Time (seconds)&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot1</span><span class="o">.</span><span class="n">showGrid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot1</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">enableAutoSIPrefix</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># stop the auto unit scaling on y axes</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_2</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#setup plot 2 for device monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot2</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Device Monitor&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s2">&quot;Device (Current - Start)&quot;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span> <span class="s2">&quot;Time (seconds)&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">showGrid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">enableAutoSIPrefix</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># stop the auto unit scaling on y axes</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">widget_3</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#legend for plot 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span> <span class="o">=</span> <span class="n">customLegend</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">graphicsItem</span><span class="p">())</span>

        <span class="c1">#create the obj func line object</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_line</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotCurveItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">pen</span><span class="o">=</span><span class="n">pen</span><span class="p">,</span> <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_value</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotCurveItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                                               <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot1</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_func_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_obj_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot1</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_func_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.setUpMultiPlot"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.setUpMultiPlot">[docs]</a>    <span class="k">def</span> <span class="nf">setUpMultiPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset plots when a new scan is started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multilines</span>      <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiPvData</span>     <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiPlotStarts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leg2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span> <span class="o">=</span> <span class="n">customLegend</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">graphicsItem</span><span class="p">())</span>

        <span class="n">default_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">51</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">255</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>

            <span class="c1">#set the first 4 devices to have the same default colors</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">default_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randColor</span><span class="p">()</span>

            <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multilines</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotCurveItem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">pen</span><span class="p">,</span> <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiPvData</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiPlotStarts</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multilines</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leg2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multilines</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">],</span> <span class="n">dev</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.randColor"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.randColor">[docs]</a>    <span class="k">def</span> <span class="nf">randColor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate random line color for each device plotted.</span>
<span class="sd">        :return: QColor object of a random color</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">)</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.run_editor"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.run_editor">[docs]</a>    <span class="k">def</span> <span class="nf">run_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the editor for edition of the objective function in obj_function.py</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
            <span class="c1">#subprocess.call([&#39;open&#39;, &#39;-a&#39;, &#39;TextEdit&#39;, self.path_to_obj_func])</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_obj_func</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Windows</span><span class="se">\\</span><span class="s1">System32</span><span class="se">\\</span><span class="s1">notepad.exe&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_obj_func</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;gedit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_obj_func</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown platform&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_obj_fun</span><span class="p">()</span></div>

<div class="viewcode-block" id="OcelotInterfaceWindow.error_box"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.OcelotInterfaceWindow.error_box">[docs]</a>    <span class="k">def</span> <span class="nf">error_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error box&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div></div>
        <span class="c1">#QtGui.QMessageBox.critical(self, &quot;Error box&quot;, message)</span>

<div class="viewcode-block" id="customLegend"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.customLegend">[docs]</a><span class="k">class</span> <span class="nc">customLegend</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">LegendItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    STUFF FOR PG CUSTOM LEGEND (subclassed from pyqtgraph).</span>
<span class="sd">    Class responsible for drawing a single item in a LegendItem (sans label).</span>
<span class="sd">    This may be subclassed to draw custom graphics in a Legend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">LegendItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

<div class="viewcode-block" id="customLegend.addItem"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.customLegend.addItem">[docs]</a>    <span class="k">def</span> <span class="nf">addItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;CCFF00&quot;</span><span class="p">):</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">LabelItem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;6pt&quot;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../optimizer.html#optimizer.generic_optim.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Funciton to start up the main program.</span>
<span class="sd">    Slecting a PV parameter set:</span>
<span class="sd">    If launched from the command line will take an argument with the filename of a parameter file.</span>
<span class="sd">    If no argv[1] is provided, the default list in ./parameters/lclsparams is used.</span>
<span class="sd">    Development mode:</span>
<span class="sd">    If devmode == False - GUI defaults to normal parameter list, defaults to nelder mead simplex</span>
<span class="sd">    if devmode == True  - GUI uses 4 development matlab PVs and loaded settings in the method &quot;devmode()&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#try to get a pv list file name from commandline arg</span>
    <span class="c1">#this goes into initializing the reset panel PVs that show up in the GUI</span>
    <span class="c1">#try:</span>
    <span class="c1">#    pvs = sys.argv[1]   # arg filename of params</span>
    <span class="c1">#except:</span>
    <span class="c1">#    pvs = &#39;parameters/lcls_short.txt&#39;#default filename</span>

    <span class="c1">#make pyqt threadsafe</span>
    <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AA_X11InitThreads</span><span class="p">)</span>

    <span class="c1">#create the application</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="c1"># setting the path variable for icon</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span><span class="p">),</span> <span class="s1">&#39;ocelot.png&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">setWindowIcon</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">OcelotInterfaceWindow</span><span class="p">()</span>
    <span class="c1"># setting the path variable for icon</span>
    <span class="c1">#path = os.path.join(os.path.dirname(sys.modules[__name__].__file__), &#39;ocelot.png&#39;)</span>
    <span class="c1">#window.setWindowIcon(QtGui.QIcon(path))</span>

    <span class="c1">#Build the PV list from dev PVs or selected source</span>
    <span class="c1">#window.ui.widget.getPvList(pvs)</span>
    <span class="c1"># set checkbot status</span>
    <span class="c1">#window.ui.widget.uncheckBoxes()</span>

    <span class="n">timer</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">scan_finished</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="n">indicator</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
    <span class="n">indicator</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">indicate_machine_state</span><span class="p">)</span>
    <span class="n">indicator</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1">#show app</span>

    <span class="c1">#window.setWindowIcon(QtGui.QIcon(&#39;ocelot.png&#39;))</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1">#Build documentaiton if source files have changed</span>
    <span class="c1"># TODO: make more universal</span>
    <span class="c1">#os.system(&quot;cd ./docs &amp;&amp; xterm -T &#39;Ocelot Doc Builder&#39; -e &#39;bash checkDocBuild.sh&#39; &amp;&quot;)</span>
    <span class="c1">#exit script</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OcelotOptimizer 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, S.Tomin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>